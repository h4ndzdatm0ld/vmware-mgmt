---

- hosts: "nautobot_servers"
  gather_facts: true
  become: true
  become_user: "root"
  roles:
    - role: mrlesmithjr.netplan
      become: true
      netplan_enabled: true
      netplan_config_file: /etc/netplan/00-installer-config.yaml
      netplan_renderer: networkd
      netplan_remove_existing: false
      netplan_packages:
        - nplan
        - netplan.io
      netplan_apply: True
      netplan_configuration:
        network:
          version: 2
          ethernets:
            ens33:
              addresses:
                - "{{ hostvars[inventory_hostname].ansible_host }}/24"
              nameservers:
                addresses:
                  - 192.168.4.1
                  - 192.168.2.1
                  - 8.8.8.8
                  - 1.1.1.1
              gateway4: 192.168.4.1
              optional: true
              routes:
                - to: 0.0.0.0/0
                  via: 192.168.4.1
                  table: 4
              routing-policy:
                - from: 0.0.0.0/0
                  table: 4
  tasks:
    - name: "UPDATE NAMESERVER ENTRY"
      lineinfile:
        path: "/etc/resolv.conf"
        line: "nameserver 192.168.4.1"

    - name: "UPDATE CACHE"
      apt:
        update_cache: true
        cache_valid_time: 3600
        force_apt_get: true
      register: "APTGET"
    - debug:
        var: "APTGET"

    - name: "UPDATE ALL PACKAGES TO LATEST"
      apt:
        name: "*"
        state: latest
      register: "UPDATE"
      become: true
    - debug:
        var: "UPDATE"

    - name: "INSTALL SPECIFIC PACKAGES DEFINED"
      apt:
        pkg:
          - "netplan.io"
          - "needrestart"
          - "resolvconf"
          - "open-vm-tools-desktop"
          - "fuse"
          - "net-tools"
        state: "latest"

    - name: "CHECK IF SHARED FOLDER EXISTS"
      stat:
        path: "/mnt/hgfs/Pyprogz"
      register: "PYPROGZ"

    - name: "MOUNT SHARED FOLDER"
      ansible.builtin.shell:
        cmd: "mount -t fuse.vmhgfs-fuse .host:/ /mnt/hgfs -o allow_other"
      when: "not PYPROGZ.stat.exists"
      become: true

    - name: "CHANGE HOSTNAME"
      ansible.builtin.hostname:
        name: "{{ inventory_hostname | replace('_', '-') }}"
      become: true

    - name: "Add FQDN to /etc/hosts"
      lineinfile:
        dest: "/etc/hosts"
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ inventory_hostname  | replace('_', '-') }} {{ inventory_hostname_short }}"
        state: "present"

    - name: "REMOVE OLD CACHE"
      apt:
        autoclean: true

    - name: "REMOVE OLD DEPENDENCIES"
      apt:
        autoremove: true
        purge: true
